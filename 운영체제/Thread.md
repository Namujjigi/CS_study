# Thread



- 스레드
  - 경량프로세스
  - 프로세스를 실행하는 명령어들의 연속으로 연속 프로세스 상태전이의 병렬성을 위해 개발됨
  - 프로세스의 Code, Data, Heap영역을 공유하지만, Stack영역은 독립적으로 갖는다.

![image-20220203194131780](C:\Users\GD\AppData\Roaming\Typora\typora-user-images\image-20220203194131780.png)

- 단일스레드: 여러 인터럽트나 함수를 순차적으로 수행하는 프로세스
- 다중스레드: 하나의 프로세스에 여러 스레드가 존재하는 것

- 스레드의 장점
  - 응답성을 높힐 수 있다. 한 부분이 멈춰도 다른 부분에서 실행하니까
  - 파일, 메모리와 같은 리소스를 공유할 수 있다.
  - 경제적이다, 프로세스를 생성하는것 보다 비용이 적게 든다
  - 멀티코어 아키텍쳐를 활용할 수 있다.
  - 커널 개입을 필요로 하지 않기 때문에 데이터 통신 효율이 IPC보다 좋다

- 멀티코어 프로그래밍의 어려운점
  - 독립적인 부분과 병렬처리되는 부분을 구분해야 한다.
  - 밸런스를 맞춰줘야한다. 각 스레드의 실행시간을 맞춰주어야 한다.
  - 데이터 분배, 처리할 데이터를 코어에 분배를 적절히 해야한다(속도차이)
  - 순차적으로 코드가 실행되는것이 아니기 때문에 디버깅이 어렵다

- 암달의 법칙
  - 시스템을 개선할 때 얼마만큼의 성능 향상이 있는지 계산
  - 개선 후 실행시간 = 개선에 의해 영향을 받는 실행 시간 / 성능 향상 비율 + 영향을 받지 않는 실행 시간

- 사용자수준 스레드 vs 커널스레드
  - OS 개입여부에 따라 커널수준의 쓰레드, 사용자 수준의 쓰레드로 나눠진다.
  - 사용자 수준 스레드
    - 유저레벨 라이브러리로 구현
    - 운영체제가 커널 스레드를 지원하지 않아도 사용할 수 있다.
    - 스레드 하나가 블락되면 전체 스레드가 블락된다.
  - 커널 수준 스레드
    - 시스템콜을 사용하여 스레드를 생산하고 관리한다.
    - 커널이 스레드 정보를 다 알고 있다.
    - 자주 블락되는 프로그램에 좋다.
    - 커널이 모든 스레드를 관리,스케줄해야 하기 때문에 모든 스레드의 대한 스택을 만들어줘야 한다.
- 멀티 스레드 모델
  - Many to one
    - 여러 유저스레드가 하나의 커널 스레드로 매핑
    - = 유저레벨 스레드
  - One to One
    - 하나의 유저스레드가 하나의 커널 스레드로 매핑
    - 최근에 많이 사용된다
    - Many to One보다 동시성이 높다
    - 커널의 도움을 많이 받기 때문에 리소스 사용이 비효율적이다.
    - 스레드가 많으면 성능이 안좋아진다.
  - Many to Many
    - 여러 유저스레드와 여러 커널스레드로 매핑
    - 속도가 빠르다
    - Many to one과 one to one 모델의 장점을 모두 갖는다
    - 스레드생성 갯수제한이 없다
    - 구현이 어렵다.
- 스레드 라이브러리: 스레드를 생성하고 관리할 때 사용하는 API, 기본적으로 POSIX Pthreads, Windows threads, Java threads 있다



- Thread pools
  - 스레드 갯수에 상한이 없기 때문에 생기는 문제(오버헤드) 때문에 생긴 기법
  - 스레드를 미리 생성해서 풀에 담아두는 방법
  - 최대 스레드 생성갯수 제약
  - 서버에 리퀘스트가 들어올 때 미리 만들어놓은 스레드를 할당하여 처리, 처리가 끝나면 풀에 반납
- Fork/Join 
  - 병렬 처리를 위한 모델
  - 분할정복 알고리즘을 통해 재귀적으로 처리
  - 스레드를 작업별로 분할하여 처리하고 분할된 작업을 합침
- OpenMP
  - 컴파일러가 멀티스레딩을 할 수 있게끔 도와주는 것
  - 지시어 몇줄 추가해주면 멀티 스레딩이 가능하다

- GCD (Grand Central Dispatch)
  - 멀티 코어 프로세서 시스템에 대한 응용 프로그램 지원을 최적화하기 위해 Apple에서 개발한 기술
  - 스레드 관리와 실행에 대한 책임을 어플리케이션 레벨에서 운영체제 레벨로 변경
  - DispatchQueue에 등록된 각 작업을 꺼내 스레드에 할당
- Intel Threading Building Blocks (TBB)
  - intel에서 개발한 병렬처리용 C++ 라이브러리



- Threading Issue
  - fork() 명령어 실행 시 부모프로세스의 모든 정보를 복사 / 호출한 해당 스레드만 복사하는 방법으로 나뉨
  - Sigmal Handling
    - 유닉스시스템에서 이벤트 발생을 프로세스에게 알림
    - 멀티스레드 환경에서 특정 스레드에게만 시그널을 줘야할 때, 스레드별로 받을 시그널을 정해준다
  - Thread Cancelation
    - 정상적인 스레드 종료가 아닌 커널이 미리 스레드를 종료시킴
    - 비동기적 캔슬레이션: 없애고자 하는 스레드를 즉시 종료, 이 경우 사용하고 있던 리소스가 붕 뜨게되고 파일 내 컨텐츠가 망가질 수 있다.
    - 유예 캔슬레이션: 스레드가 캔슬할 수 있을 때까지 기다린 뒤 캔슬

